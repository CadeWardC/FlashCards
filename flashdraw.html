<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚öóÔ∏è</text></svg>">
    <title>FlashDraw - Chemical Structure Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* Screens */
        .screen {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Welcome Screen */
        .welcome-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .option-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: center;
        }

        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .option-card .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .option-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .option-card p {
            opacity: 0.9;
            line-height: 1.6;
        }

        /* Drawing Screen */
        .draw-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .draw-header h2 {
            color: #2d3748;
            font-size: 1.8em;
        }

        .name-input-container {
            margin-bottom: 20px;
        }

        .name-input-container label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .name-input-container input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .name-input-container input:focus {
            outline: none;
            border-color: #667eea;
        }

        .workspace {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Toolbox */
        .toolbox {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        .tool-section {
            margin-bottom: 25px;
        }

        .tool-section:last-child {
            margin-bottom: 0;
        }

        .tool-section h3 {
            color: #2d3748;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .tool-btn {
            padding: 10px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
            font-weight: 600;
            text-align: center;
        }

        .tool-btn:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .tool-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .bond-btn {
            grid-column: span 2;
        }

        /* Canvas */
        .canvas-container {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 500px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            cursor: crosshair;
            background: 
                linear-gradient(0deg, transparent 24%, rgba(200, 200, 200, 0.1) 25%, rgba(200, 200, 200, 0.1) 26%, transparent 27%, transparent 74%, rgba(200, 200, 200, 0.1) 75%, rgba(200, 200, 200, 0.1) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(200, 200, 200, 0.1) 25%, rgba(200, 200, 200, 0.1) 26%, transparent 27%, transparent 74%, rgba(200, 200, 200, 0.1) 75%, rgba(200, 200, 200, 0.1) 76%, transparent 77%, transparent);
            background-size: 40px 40px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-danger {
            background: #fc8181;
            color: white;
        }

        .btn-danger:hover {
            background: #f56565;
        }

        /* Library Screen */
        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .structure-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .structure-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .structure-card h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .structure-preview {
            width: 100%;
            height: 150px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            margin-bottom: 15px;
        }

        .structure-card .btn {
            width: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state .icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        /* Quiz Screen */
        .quiz-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .quiz-prompt h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .quiz-prompt p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* Results */
        .results-container {
            text-align: center;
            padding: 40px;
        }

        .results-score {
            font-size: 4em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .results-score.perfect {
            color: #48bb78;
        }

        .results-score.good {
            color: #ed8936;
        }

        .results-score.poor {
            color: #f56565;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .comparison-panel {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
        }

        .comparison-panel h3 {
            color: #2d3748;
            margin-bottom: 15px;
        }

        .comparison-panel canvas {
            width: 100%;
            height: 300px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            background: white;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .screen.active {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öóÔ∏è FlashDraw</h1>
            <p>Draw and Quiz Chemical Structures</p>
        </div>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen active">
            <h2 style="color: #2d3748; margin-bottom: 20px; text-align: center;">What would you like to do?</h2>
            <div class="welcome-grid">
                <div class="option-card" onclick="showDrawScreen()">
                    <div class="icon">‚úèÔ∏è</div>
                    <h3>Create Structure</h3>
                    <p>Draw a new chemical structure to add to your library</p>
                </div>
                <div class="option-card" onclick="showLibraryScreen()">
                    <div class="icon">üìö</div>
                    <h3>Practice Quiz</h3>
                    <p>Quiz yourself on saved structures</p>
                </div>
            </div>
        </div>

        <!-- Drawing Screen -->
        <div id="drawScreen" class="screen">
            <div class="draw-header">
                <h2>Create Chemical Structure</h2>
                <button class="btn btn-secondary" onclick="showWelcomeScreen()">‚Üê Back</button>
            </div>

            <div class="name-input-container">
                <label for="structureName">Structure Name</label>
                <input type="text" id="structureName" placeholder="e.g., Ethanol, Benzene, Acetone">
            </div>

            <div class="workspace">
                <div class="toolbox">
                    <div class="tool-section">
                        <h3>Atoms</h3>
                        <div class="tool-grid">
                            <button class="tool-btn active" data-atom="C" onclick="selectAtom('C')">C</button>
                            <button class="tool-btn" data-atom="H" onclick="selectAtom('H')">H</button>
                            <button class="tool-btn" data-atom="O" onclick="selectAtom('O')">O</button>
                            <button class="tool-btn" data-atom="N" onclick="selectAtom('N')">N</button>
                            <button class="tool-btn" data-atom="S" onclick="selectAtom('S')">S</button>
                            <button class="tool-btn" data-atom="P" onclick="selectAtom('P')">P</button>
                            <button class="tool-btn" data-atom="F" onclick="selectAtom('F')">F</button>
                            <button class="tool-btn" data-atom="Cl" onclick="selectAtom('Cl')">Cl</button>
                            <button class="tool-btn" data-atom="Br" onclick="selectAtom('Br')">Br</button>
                            <button class="tool-btn" data-atom="I" onclick="selectAtom('I')">I</button>
                        </div>
                    </div>

                    <div class="tool-section">
                        <h3>Bonds</h3>
                        <div class="tool-grid">
                            <button class="tool-btn bond-btn" data-bond="single" onclick="selectBond('single')">‚îÄ Single</button>
                            <button class="tool-btn bond-btn" data-bond="double" onclick="selectBond('double')">‚ïê Double</button>
                            <button class="tool-btn bond-btn" data-bond="triple" onclick="selectBond('triple')">‚â° Triple</button>
                        </div>
                    </div>

                    <div class="tool-section">
                        <h3>Bond Length</h3>
                        <input type="range" id="bondLengthSlider" min="40" max="120" value="80" 
                               style="width: 100%;" oninput="updateBondLength(this.value)">
                        <div style="text-align: center; color: #4a5568; font-size: 0.85em; margin-top: 5px;">
                            <span id="bondLengthValue">80</span>px
                        </div>
                    </div>
                </div>

                <div class="canvas-container">
                    <canvas id="drawCanvas"></canvas>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-danger" onclick="clearCanvas()">Clear Canvas</button>
                <button class="btn btn-primary" onclick="saveStructure()">Save Structure</button>
            </div>
        </div>

        <!-- Library Screen -->
        <div id="libraryScreen" class="screen">
            <div class="draw-header">
                <h2>Your Structure Library</h2>
                <button class="btn btn-secondary" onclick="showWelcomeScreen()">‚Üê Back</button>
            </div>

            <div id="libraryContent" class="library-grid"></div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="screen">
            <div class="draw-header">
                <h2>Practice Quiz</h2>
                <button class="btn btn-secondary" onclick="showLibraryScreen()">‚Üê Back</button>
            </div>

            <div class="quiz-prompt">
                <h2>Draw:</h2>
                <p id="quizStructureName"></p>
            </div>

            <div class="workspace">
                <div class="toolbox">
                    <div class="tool-section">
                        <h3>Atoms</h3>
                        <div class="tool-grid">
                            <button class="tool-btn active" data-atom="C" onclick="selectQuizAtom('C')">C</button>
                            <button class="tool-btn" data-atom="H" onclick="selectQuizAtom('H')">H</button>
                            <button class="tool-btn" data-atom="O" onclick="selectQuizAtom('O')">O</button>
                            <button class="tool-btn" data-atom="N" onclick="selectQuizAtom('N')">N</button>
                            <button class="tool-btn" data-atom="S" onclick="selectQuizAtom('S')">S</button>
                            <button class="tool-btn" data-atom="P" onclick="selectQuizAtom('P')">P</button>
                            <button class="tool-btn" data-atom="F" onclick="selectQuizAtom('F')">F</button>
                            <button class="tool-btn" data-atom="Cl" onclick="selectQuizAtom('Cl')">Cl</button>
                            <button class="tool-btn" data-atom="Br" onclick="selectQuizAtom('Br')">Br</button>
                            <button class="tool-btn" data-atom="I" onclick="selectQuizAtom('I')">I</button>
                        </div>
                    </div>

                    <div class="tool-section">
                        <h3>Bonds</h3>
                        <div class="tool-grid">
                            <button class="tool-btn bond-btn" data-bond="single" onclick="selectQuizBond('single')">‚îÄ Single</button>
                            <button class="tool-btn bond-btn" data-bond="double" onclick="selectQuizBond('double')">‚ïê Double</button>
                            <button class="tool-btn bond-btn" data-bond="triple" onclick="selectQuizBond('triple')">‚â° Triple</button>
                        </div>
                    </div>

                    <div class="tool-section">
                        <h3>Bond Length</h3>
                        <input type="range" id="quizBondLengthSlider" min="40" max="120" value="80" 
                               style="width: 100%;" oninput="updateBondLength(this.value)">
                        <div style="text-align: center; color: #4a5568; font-size: 0.85em; margin-top: 5px;">
                            <span id="quizBondLengthValue">80</span>px
                        </div>
                    </div>
                </div>

                <div class="canvas-container">
                    <canvas id="quizCanvas"></canvas>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-danger" onclick="clearQuizCanvas()">Clear Canvas</button>
                <button class="btn btn-primary" onclick="submitQuiz()">Submit Answer</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="screen">
            <div class="draw-header">
                <h2>Quiz Results</h2>
                <button class="btn btn-secondary" onclick="showLibraryScreen()">‚Üê Back to Library</button>
            </div>

            <div class="results-container">
                <div id="resultsScore" class="results-score"></div>
                <div id="resultsMessage" style="font-size: 1.5em; color: #4a5568; margin-bottom: 30px;"></div>

                <div class="comparison">
                    <div class="comparison-panel">
                        <h3>Original Structure</h3>
                        <canvas id="originalCanvas"></canvas>
                    </div>
                    <div class="comparison-panel">
                        <h3>Your Answer</h3>
                        <canvas id="answerCanvas"></canvas>
                    </div>
                </div>

                <div class="action-buttons" style="justify-content: center;">
                    <button class="btn btn-secondary" onclick="showLibraryScreen()">Back to Library</button>
                    <button class="btn btn-primary" onclick="retryQuiz()">Try Again</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data structures
        let structures = [];
        let currentStructure = null;
        let currentQuizStructure = null;

        // Canvas setup
        const drawCanvas = document.getElementById('drawCanvas');
        const drawCtx = drawCanvas.getContext('2d');
        const quizCanvas = document.getElementById('quizCanvas');
        const quizCtx = quizCanvas.getContext('2d');

        // Drawing state
        let drawAtoms = [];
        let drawBonds = [];
        let selectedAtom = 'C';
        let selectedBond = null;
        let bondStartAtom = null;
        let bondLength = 80; // Fixed bond length in pixels
        let angleSnap = 30; // Snap to 30 degree increments

        // Quiz state
        let quizAtoms = [];
        let quizBonds = [];
        let quizSelectedAtom = 'C';
        let quizSelectedBond = null;
        let quizBondStartAtom = null;

        // Atom colors
        const atomColors = {
            'C': '#2d3748',
            'H': '#718096',
            'O': '#e53e3e',
            'N': '#3182ce',
            'S': '#d69e2e',
            'P': '#dd6b20',
            'F': '#38a169',
            'Cl': '#38a169',
            'Br': '#c05621',
            'I': '#6b46c1'
        };

        // Initialize canvases
        function initCanvases() {
            drawCanvas.width = drawCanvas.offsetWidth;
            drawCanvas.height = 500;
            quizCanvas.width = quizCanvas.offsetWidth;
            quizCanvas.height = 500;
        }

        // Load saved structures
        function loadStructures() {
            const saved = localStorage.getItem('chemStructures');
            if (saved) {
                structures = JSON.parse(saved);
            }
        }

        // Save structures
        function saveStructures() {
            localStorage.setItem('chemStructures', JSON.stringify(structures));
        }

        // Screen navigation
        function showWelcomeScreen() {
            hideAllScreens();
            document.getElementById('welcomeScreen').classList.add('active');
        }

        function showDrawScreen() {
            hideAllScreens();
            document.getElementById('drawScreen').classList.add('active');
            document.getElementById('structureName').value = '';
            clearCanvas();
            initCanvases();
        }

        function showLibraryScreen() {
            hideAllScreens();
            document.getElementById('libraryScreen').classList.add('active');
            renderLibrary();
        }

        function showQuizScreen(structure) {
            hideAllScreens();
            currentQuizStructure = structure;
            document.getElementById('quizScreen').classList.add('active');
            document.getElementById('quizStructureName').textContent = structure.name;
            clearQuizCanvas();
            initCanvases();
        }

        function showResultsScreen() {
            hideAllScreens();
            document.getElementById('resultsScreen').classList.add('active');
        }

        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
        }

        // Tool selection
        function selectAtom(atom) {
            selectedAtom = atom;
            selectedBond = null;
            bondStartAtom = null;
            
            document.querySelectorAll('#drawScreen [data-atom]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`#drawScreen [data-atom="${atom}"]`).classList.add('active');
            
            document.querySelectorAll('#drawScreen [data-bond]').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function selectBond(bond) {
            selectedBond = bond;
            
            document.querySelectorAll('#drawScreen [data-bond]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`#drawScreen [data-bond="${bond}"]`).classList.add('active');
        }

        function selectQuizAtom(atom) {
            quizSelectedAtom = atom;
            quizSelectedBond = null;
            quizBondStartAtom = null;
            
            document.querySelectorAll('#quizScreen [data-atom]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`#quizScreen [data-atom="${atom}"]`).classList.add('active');
            
            document.querySelectorAll('#quizScreen [data-bond]').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function selectQuizBond(bond) {
            quizSelectedBond = bond;
            
            document.querySelectorAll('#quizScreen [data-bond]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`#quizScreen [data-bond="${bond}"]`).classList.add('active');
        }

        function updateBondLength(value) {
            bondLength = parseInt(value);
            document.getElementById('bondLengthValue').textContent = value;
            const quizValue = document.getElementById('quizBondLengthValue');
            if (quizValue) {
                quizValue.textContent = value;
                document.getElementById('quizBondLengthSlider').value = value;
            }
        }

        // Helper function to check if atom is bonded
        function isAtomBonded(atomId, bonds) {
            return bonds.some(bond => bond.atom1 === atomId || bond.atom2 === atomId);
        }

        // Helper function to snap angle
        function snapAngle(angle) {
            const snapDeg = angleSnap;
            const snapRad = snapDeg * Math.PI / 180;
            return Math.round(angle / snapRad) * snapRad;
        }

        // Helper function to calculate bond endpoint with constraints
        function calculateBondEndpoint(startX, startY, mouseX, mouseY) {
            const dx = mouseX - startX;
            const dy = mouseY - startY;
            let angle = Math.atan2(dy, dx);
            
            // Snap to angle increments
            angle = snapAngle(angle);
            
            // Apply fixed bond length
            const endX = startX + Math.cos(angle) * bondLength;
            const endY = startY + Math.sin(angle) * bondLength;
            
            return { x: endX, y: endY };
        }

        // Canvas drawing
        function drawStructure(ctx, atoms, bonds, highlightAtom = null) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            
            // Draw bonds first
            bonds.forEach(bond => {
                const atom1 = atoms.find(a => a.id === bond.atom1);
                const atom2 = atoms.find(a => a.id === bond.atom2);
                
                if (atom1 && atom2) {
                    ctx.strokeStyle = '#4a5568';
                    ctx.lineWidth = 2;
                    
                    if (bond.type === 'single') {
                        ctx.beginPath();
                        ctx.moveTo(atom1.x, atom1.y);
                        ctx.lineTo(atom2.x, atom2.y);
                        ctx.stroke();
                    } else if (bond.type === 'double') {
                        const dx = atom2.x - atom1.x;
                        const dy = atom2.y - atom1.y;
                        const len = Math.sqrt(dx * dx + dy * dy);
                        const offsetX = -dy / len * 3;
                        const offsetY = dx / len * 3;
                        
                        ctx.beginPath();
                        ctx.moveTo(atom1.x + offsetX, atom1.y + offsetY);
                        ctx.lineTo(atom2.x + offsetX, atom2.y + offsetY);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(atom1.x - offsetX, atom1.y - offsetY);
                        ctx.lineTo(atom2.x - offsetX, atom2.y - offsetY);
                        ctx.stroke();
                    } else if (bond.type === 'triple') {
                        const dx = atom2.x - atom1.x;
                        const dy = atom2.y - atom1.y;
                        const len = Math.sqrt(dx * dx + dy * dy);
                        const offsetX = -dy / len * 5;
                        const offsetY = dx / len * 5;
                        
                        ctx.beginPath();
                        ctx.moveTo(atom1.x, atom1.y);
                        ctx.lineTo(atom2.x, atom2.y);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(atom1.x + offsetX, atom1.y + offsetY);
                        ctx.lineTo(atom2.x + offsetX, atom2.y + offsetY);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(atom1.x - offsetX, atom1.y - offsetY);
                        ctx.lineTo(atom2.x - offsetX, atom2.y - offsetY);
                        ctx.stroke();
                    }
                }
            });
            
            // Draw atoms
            atoms.forEach(atom => {
                const isBonded = isAtomBonded(atom.id, bonds);
                const isHighlighted = highlightAtom && highlightAtom.id === atom.id;
                
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Background circle with thinner line
                ctx.fillStyle = isBonded ? '#f7fafc' : 'white';
                ctx.beginPath();
                ctx.arc(atom.x, atom.y, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // Highlight if selected for bonding
                if (isHighlighted) {
                    ctx.strokeStyle = '#667eea';
                    ctx.lineWidth = 3;
                } else {
                    ctx.strokeStyle = isBonded ? '#cbd5e0' : atomColors[atom.symbol];
                    ctx.lineWidth = 1;
                }
                ctx.stroke();
                
                // Atom symbol (grayed out if bonded)
                ctx.fillStyle = isBonded ? '#a0aec0' : atomColors[atom.symbol];
                ctx.fillText(atom.symbol, atom.x, atom.y);
            });
        }

        // Canvas click handlers
        drawCanvas.addEventListener('click', (e) => {
            const rect = drawCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const clickedAtom = findAtom(x, y, drawAtoms);
            
            if (selectedBond && bondStartAtom === null && clickedAtom) {
                // Start bond from existing atom
                bondStartAtom = clickedAtom;
                drawStructure(drawCtx, drawAtoms, drawBonds, bondStartAtom);
            } else if (selectedBond && bondStartAtom && clickedAtom && clickedAtom !== bondStartAtom) {
                // Complete bond to existing atom
                drawBonds.push({
                    id: Date.now(),
                    atom1: bondStartAtom.id,
                    atom2: clickedAtom.id,
                    type: selectedBond
                });
                bondStartAtom = null;
                drawStructure(drawCtx, drawAtoms, drawBonds);
            } else if (selectedBond && bondStartAtom && !clickedAtom) {
                // Create new atom at fixed length and snapped angle
                const endpoint = calculateBondEndpoint(bondStartAtom.x, bondStartAtom.y, x, y);
                
                const newAtom = {
                    id: Date.now(),
                    x: endpoint.x,
                    y: endpoint.y,
                    symbol: selectedAtom
                };
                drawAtoms.push(newAtom);
                drawBonds.push({
                    id: Date.now() + 1,
                    atom1: bondStartAtom.id,
                    atom2: newAtom.id,
                    type: selectedBond
                });
                bondStartAtom = null;
                drawStructure(drawCtx, drawAtoms, drawBonds);
            } else if (!selectedBond && !clickedAtom) {
                // Place new atom
                drawAtoms.push({
                    id: Date.now(),
                    x: x,
                    y: y,
                    symbol: selectedAtom
                });
                drawStructure(drawCtx, drawAtoms, drawBonds);
            } else if (selectedBond && bondStartAtom) {
                // Cancel bond if clicking same spot
                bondStartAtom = null;
                drawStructure(drawCtx, drawAtoms, drawBonds);
            }
        });

        // Show preview while creating bond
        drawCanvas.addEventListener('mousemove', (e) => {
            if (bondStartAtom && selectedBond) {
                const rect = drawCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                drawStructure(drawCtx, drawAtoms, drawBonds, bondStartAtom);
                
                const endpoint = calculateBondEndpoint(bondStartAtom.x, bondStartAtom.y, x, y);
                
                // Draw preview line
                drawCtx.strokeStyle = '#667eea';
                drawCtx.lineWidth = 2;
                drawCtx.setLineDash([5, 5]);
                drawCtx.beginPath();
                drawCtx.moveTo(bondStartAtom.x, bondStartAtom.y);
                drawCtx.lineTo(endpoint.x, endpoint.y);
                drawCtx.stroke();
                drawCtx.setLineDash([]);
                
                // Draw preview atom
                drawCtx.fillStyle = 'rgba(102, 126, 234, 0.3)';
                drawCtx.beginPath();
                drawCtx.arc(endpoint.x, endpoint.y, 15, 0, Math.PI * 2);
                drawCtx.fill();
                drawCtx.strokeStyle = '#667eea';
                drawCtx.lineWidth = 1;
                drawCtx.stroke();
            }
        });

        quizCanvas.addEventListener('click', (e) => {
            const rect = quizCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const clickedAtom = findAtom(x, y, quizAtoms);
            
            if (quizSelectedBond && quizBondStartAtom === null && clickedAtom) {
                quizBondStartAtom = clickedAtom;
                drawStructure(quizCtx, quizAtoms, quizBonds, quizBondStartAtom);
            } else if (quizSelectedBond && quizBondStartAtom && clickedAtom && clickedAtom !== quizBondStartAtom) {
                quizBonds.push({
                    id: Date.now(),
                    atom1: quizBondStartAtom.id,
                    atom2: clickedAtom.id,
                    type: quizSelectedBond
                });
                quizBondStartAtom = null;
                drawStructure(quizCtx, quizAtoms, quizBonds);
            } else if (quizSelectedBond && quizBondStartAtom && !clickedAtom) {
                const endpoint = calculateBondEndpoint(quizBondStartAtom.x, quizBondStartAtom.y, x, y);
                
                const newAtom = {
                    id: Date.now(),
                    x: endpoint.x,
                    y: endpoint.y,
                    symbol: quizSelectedAtom
                };
                quizAtoms.push(newAtom);
                quizBonds.push({
                    id: Date.now() + 1,
                    atom1: quizBondStartAtom.id,
                    atom2: newAtom.id,
                    type: quizSelectedBond
                });
                quizBondStartAtom = null;
                drawStructure(quizCtx, quizAtoms, quizBonds);
            } else if (!quizSelectedBond && !clickedAtom) {
                quizAtoms.push({
                    id: Date.now(),
                    x: x,
                    y: y,
                    symbol: quizSelectedAtom
                });
                drawStructure(quizCtx, quizAtoms, quizBonds);
            } else if (quizSelectedBond && quizBondStartAtom) {
                quizBondStartAtom = null;
                drawStructure(quizCtx, quizAtoms, quizBonds);
            }
        });

        // Show preview while creating bond in quiz
        quizCanvas.addEventListener('mousemove', (e) => {
            if (quizBondStartAtom && quizSelectedBond) {
                const rect = quizCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                drawStructure(quizCtx, quizAtoms, quizBonds, quizBondStartAtom);
                
                const endpoint = calculateBondEndpoint(quizBondStartAtom.x, quizBondStartAtom.y, x, y);
                
                // Draw preview line
                quizCtx.strokeStyle = '#667eea';
                quizCtx.lineWidth = 2;
                quizCtx.setLineDash([5, 5]);
                quizCtx.beginPath();
                quizCtx.moveTo(quizBondStartAtom.x, quizBondStartAtom.y);
                quizCtx.lineTo(endpoint.x, endpoint.y);
                quizCtx.stroke();
                quizCtx.setLineDash([]);
                
                // Draw preview atom
                quizCtx.fillStyle = 'rgba(102, 126, 234, 0.3)';
                quizCtx.beginPath();
                quizCtx.arc(endpoint.x, endpoint.y, 15, 0, Math.PI * 2);
                quizCtx.fill();
                quizCtx.strokeStyle = '#667eea';
                quizCtx.lineWidth = 1;
                quizCtx.stroke();
            }
        });

        function findAtom(x, y, atoms) {
            return atoms.find(atom => {
                const dx = atom.x - x;
                const dy = atom.y - y;
                return Math.sqrt(dx * dx + dy * dy) < 20;
            });
        }

        // Canvas actions
        function clearCanvas() {
            drawAtoms = [];
            drawBonds = [];
            bondStartAtom = null;
            if (drawCtx) {
                drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
            }
        }

        function clearQuizCanvas() {
            quizAtoms = [];
            quizBonds = [];
            quizBondStartAtom = null;
            if (quizCtx) {
                quizCtx.clearRect(0, 0, quizCanvas.width, quizCanvas.height);
            }
        }

        // Structure management
        function saveStructure() {
            const name = document.getElementById('structureName').value.trim();
            
            if (!name) {
                alert('Please enter a structure name!');
                return;
            }
            
            if (drawAtoms.length === 0) {
                alert('Please draw a structure first!');
                return;
            }
            
            structures.push({
                id: Date.now(),
                name: name,
                atoms: JSON.parse(JSON.stringify(drawAtoms)),
                bonds: JSON.parse(JSON.stringify(drawBonds))
            });
            
            saveStructures();
            alert('Structure saved successfully!');
            showLibraryScreen();
        }

        function renderLibrary() {
            const container = document.getElementById('libraryContent');
            
            if (structures.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="icon">üì≠</div>
                        <h3>No Structures Yet</h3>
                        <p>Create your first chemical structure to get started!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            structures.forEach(structure => {
                const card = document.createElement('div');
                card.className = 'structure-card';
                card.innerHTML = `
                    <h3>${structure.name}</h3>
                    <canvas class="structure-preview" data-id="${structure.id}"></canvas>
                    <button class="btn btn-primary" onclick="startQuiz(${structure.id})">Practice</button>
                `;
                container.appendChild(card);
                
                // Draw preview
                const canvas = card.querySelector('canvas');
                canvas.width = canvas.offsetWidth;
                canvas.height = 150;
                const ctx = canvas.getContext('2d');
                
                // Scale structure to fit
                const atoms = structure.atoms.map(a => ({...a}));
                const minX = Math.min(...atoms.map(a => a.x));
                const maxX = Math.max(...atoms.map(a => a.x));
                const minY = Math.min(...atoms.map(a => a.y));
                const maxY = Math.max(...atoms.map(a => a.y));
                const width = maxX - minX;
                const height = maxY - minY;
                const scale = Math.min((canvas.width - 40) / width, (canvas.height - 40) / height);
                
                atoms.forEach(atom => {
                    atom.x = (atom.x - minX) * scale + 20;
                    atom.y = (atom.y - minY) * scale + 20;
                });
                
                drawStructure(ctx, atoms, structure.bonds, null);
            });
        }

        function startQuiz(structureId) {
            const structure = structures.find(s => s.id === structureId);
            if (structure) {
                showQuizScreen(structure);
            }
        }

        function submitQuiz() {
            if (quizAtoms.length === 0) {
                alert('Please draw your answer first!');
                return;
            }
            
            const score = compareStructures(currentQuizStructure, {atoms: quizAtoms, bonds: quizBonds});
            showResults(score);
        }

        function compareStructures(original, answer) {
            let score = 0;
            let total = 0;
            
            // Compare atom counts
            total += 10;
            if (original.atoms.length === answer.atoms.length) {
                score += 10;
            }
            
            // Compare bond counts
            total += 10;
            if (original.bonds.length === answer.bonds.length) {
                score += 10;
            }
            
            // Compare atom types
            const originalAtomTypes = original.atoms.map(a => a.symbol).sort();
            const answerAtomTypes = answer.atoms.map(a => a.symbol).sort();
            total += 30;
            const matchingAtoms = originalAtomTypes.filter((atom, i) => atom === answerAtomTypes[i]).length;
            score += (matchingAtoms / originalAtomTypes.length) * 30;
            
            // Compare bond types
            const originalBondTypes = original.bonds.map(b => b.type).sort();
            const answerBondTypes = answer.bonds.map(b => b.type).sort();
            total += 30;
            const matchingBonds = originalBondTypes.filter((bond, i) => bond === answerBondTypes[i]).length;
            score += (matchingBonds / Math.max(originalBondTypes.length, 1)) * 30;
            
            // Connectivity bonus
            total += 20;
            score += 10; // Partial credit for attempting
            
            return Math.round((score / total) * 100);
        }

        function showResults(score) {
            showResultsScreen();
            
            const scoreEl = document.getElementById('resultsScore');
            const messageEl = document.getElementById('resultsMessage');
            
            scoreEl.textContent = score + '%';
            
            if (score >= 90) {
                scoreEl.className = 'results-score perfect';
                messageEl.textContent = 'üéâ Perfect! Outstanding work!';
            } else if (score >= 70) {
                scoreEl.className = 'results-score good';
                messageEl.textContent = 'üëç Good job! Close match!';
            } else {
                scoreEl.className = 'results-score poor';
                messageEl.textContent = 'üí™ Keep practicing!';
            }
            
            // Draw comparison
            const originalCanvas = document.getElementById('originalCanvas');
            const answerCanvas = document.getElementById('answerCanvas');
            originalCanvas.width = originalCanvas.offsetWidth;
            originalCanvas.height = 300;
            answerCanvas.width = answerCanvas.offsetWidth;
            answerCanvas.height = 300;
            
            drawStructure(originalCanvas.getContext('2d'), currentQuizStructure.atoms, currentQuizStructure.bonds, null);
            drawStructure(answerCanvas.getContext('2d'), quizAtoms, quizBonds, null);
        }

        function retryQuiz() {
            clearQuizCanvas();
            showQuizScreen(currentQuizStructure);
        }

        // Initialize
        window.addEventListener('load', () => {
            loadStructures();
            initCanvases();
        });

        window.addEventListener('resize', () => {
            initCanvases();
            if (drawAtoms.length > 0) {
                drawStructure(drawCtx, drawAtoms, drawBonds);
            }
            if (quizAtoms.length > 0) {
                drawStructure(quizCtx, quizAtoms, quizBonds);
            }
        });
    </script>
</body>
</html>
