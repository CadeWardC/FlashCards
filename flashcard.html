<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashStudying</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .screen {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        /* Create Set Screen */
        .set-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #4a5568;
        }

        .set-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .set-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .card-item {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .card-item:hover {
            border-color: #cbd5e0;
            transform: translateY(-2px);
        }

        .card-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .card-input-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card-input {
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1em;
            resize: vertical;
            min-height: 60px;
        }

        .card-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .image-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .image-btn {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-btn:hover {
            background: #cbd5e0;
        }

        .image-btn.active {
            background: #667eea;
            color: white;
        }

        .image-input {
            margin-top: 8px;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .image-preview {
            margin-top: 10px;
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            object-fit: cover;
        }

        .remove-image {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            margin-top: 5px;
        }

        .remove-image:hover {
            background: #c53030;
        }

        /* Study screen image styles */
        .card-content {
            text-align: center;
            padding: 40px;
            font-size: 1.3em;
            line-height: 1.5;
            word-wrap: break-word;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .card-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            object-fit: contain;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .card-text {
            flex: 1;
        }

        .remove-card {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .remove-card:hover {
            background: #c53030;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .btn-success {
            background: #38a169;
        }

        .btn-success:hover {
            background: #2f855a;
        }

        .button-container {
            text-align: center;
            margin-top: 30px;
        }

        /* Study Screen */
        .study-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .study-title {
            font-size: 1.8em;
            color: #2d3748;
        }

        .progress {
            font-size: 1.1em;
            color: #718096;
        }

        .flashcard {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            perspective: 1000px;
        }

        .flashcard:hover {
            border-color: #cbd5e0;
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .card-content {
            text-align: center;
            padding: 40px;
            font-size: 1.3em;
            line-height: 1.5;
            word-wrap: break-word;
            width: 100%;
        }

        .card-flip-hint {
            position: absolute;
            bottom: 15px;
            right: 20px;
            color: #a0aec0;
            font-size: 0.9em;
        }

        .study-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .nav-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .flip-indicator {
            text-align: center;
            margin: 20px 0;
            color: #718096;
            font-style: italic;
        }

        .sets-list {
            margin-top: 20px;
        }

        .set-item {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .set-item:hover {
            border-color: #cbd5e0;
            transform: translateY(-2px);
        }

        .set-info h3 {
            color: #2d3748;
            margin-bottom: 5px;
        }

        .set-info p {
            color: #718096;
            font-size: 0.9em;
        }

        .set-actions {
            display: flex;
            gap: 10px;
        }

        .welcome-screen {
            text-align: center;
            padding: 60px 40px;
        }

        .welcome-screen h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .welcome-screen p {
            font-size: 1.1em;
            color: #718096;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        /* Bulk Import Styles */
        .bulk-import-section {
            margin-bottom: 25px;
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 20px;
            background: #f8fafc;
            transition: all 0.3s ease;
        }

        .bulk-import-section:hover {
            border-color: #a0aec0;
        }

        .import-toggle {
            text-align: center;
            margin-bottom: 15px;
        }

        .import-instructions {
            background: #edf2f7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.95em;
        }

        .import-instructions p {
            margin-bottom: 8px;
            color: #4a5568;
        }

        .import-instructions code {
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #2d3748;
        }

        .bulk-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.95em;
            resize: vertical;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .bulk-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .import-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .cards-separator {
            text-align: center;
            margin: 20px 0;
            color: #718096;
            font-weight: 500;
        }

        .cards-separator::before,
        .cards-separator::after {
            content: '';
            display: inline-block;
            width: 60px;
            height: 1px;
            background: #cbd5e0;
            vertical-align: middle;
            margin: 0 15px;
        }

        .file-drop-zone {
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .file-drop-zone p {
            margin: 10px 0;
            color: #718096;
        }

        .file-drop-zone .file-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .card-inputs {
                grid-template-columns: 1fr;
            }
            
            .study-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .study-controls {
                flex-direction: column;
                align-items: center;
            }

            .nav-btn {
                width: 100%;
                max-width: 200px;
            }

            .import-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 Flashcard Study App</h1>
        </div>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen">
            <div class="welcome-screen">
                <h2>Study In a Flash</h2>
                <p>Create flashcard sets and study them with an intuitive interface. Start by creating your first set.</p>
                <div class="button-container">
                    <button class="btn btn-success" onclick="showCreateScreen()">+ Create New Set</button>
                    <button class="btn btn-secondary" onclick="showBrowseScreen()" id="browseBtn" style="display: none;">Browse Sets</button>
                    <button class="btn" onclick="triggerImportFile()">📁 Import Set</button>
                </div>
                <input type="file" id="fileImport" accept=".json,.txt" style="display: none;" onchange="handleFileImport(event)">
            </div>
            <div class="sets-list" id="welcomeSets"></div>
        </div>

        <!-- Create Set Screen -->
        <div id="createScreen" class="screen hidden">
            <div class="set-title">Create a New Flashcard Set</div>
            
            <input type="text" class="set-input" id="setTitle" placeholder="Enter a title for your set (e.g., 'Spanish Vocabulary', 'History Terms')">
            <input type="text" class="set-input" id="setDescription" placeholder="Add a description (optional)">
            
            <!-- Bulk Import Section -->
            <div class="bulk-import-section" id="bulkImportSection">
                <div class="import-toggle">
                    <button class="btn btn-secondary" onclick="toggleBulkImport()" id="bulkImportToggle">📝 Bulk Import</button>
                </div>
                <div class="bulk-import-area hidden" id="bulkImportArea">
                    <div class="import-instructions">
                        <p><strong>Quick Import:</strong> Paste your terms and definitions, one per line</p>
                        <p><strong>Format:</strong> <code>term/definition</code> or <code>term | definition</code></p>
                        <p><em>Example:</em> <code>apple/a red fruit</code></p>
                    </div>
                    <textarea class="bulk-textarea" id="bulkTextarea" 
                        placeholder="apple/a red fruit&#10;cat/a small domestic animal&#10;run/to move quickly on foot&#10;&#10;Paste your content here..."></textarea>
                    <div class="import-actions">
                        <button class="btn" onclick="processBulkImport()">Import Cards</button>
                        <button class="btn btn-secondary" onclick="clearBulkImport()">Clear</button>
                    </div>
                </div>
            </div>
            
            <div id="cardsList">
                <div class="card-item">
                    <div class="card-inputs">
                        <textarea class="card-input" placeholder="Enter the term or question" rows="3"></textarea>
                        <textarea class="card-input" placeholder="Enter the definition or answer" rows="3"></textarea>
                    </div>
                    <button class="remove-card" onclick="removeCard(this)" style="display: none;">Remove</button>
                </div>
            </div>

            <div class="button-container">
                <button class="btn" onclick="addCard()">+ Add Card</button>
                <button class="btn" onclick="triggerImportFile()">📁 Import from File</button>
                <button class="btn btn-success" onclick="saveSet()">Save Set</button>
                <button class="btn btn-secondary" onclick="showWelcomeScreen()">Cancel</button>
            </div>
            
            <input type="file" id="createFileImport" accept=".json,.txt" style="display: none;" onchange="handleCreateFileImport(event)">
        </div>

        <!-- Study Screen -->
        <div id="studyScreen" class="screen hidden">
            <div class="study-header">
                <h2 class="study-title" id="studyTitle">Study Set</h2>
                <div class="progress" id="progress">1 / 10</div>
            </div>

            <div class="flashcard" id="flashcard" onclick="flipCard()">
                <div class="card-content" id="cardContent">Click to start studying</div>
                <div class="card-flip-hint">Click to flip</div>
            </div>

            <div class="flip-indicator" id="flipIndicator">Showing: Front</div>

            <div class="study-controls">
                <button class="nav-btn" id="prevBtn" onclick="previousCard()" disabled>← Previous</button>
                <button class="nav-btn" onclick="shuffleCards()" id="shuffleBtn">🔀 Shuffle</button>
                <button class="btn btn-secondary" onclick="showWelcomeScreen()">← Back to Sets</button>
                <button class="nav-btn" id="nextBtn" onclick="nextCard()">Next →</button>
            </div>
        </div>
    </div>
    <div style="position: fixed; bottom: 10px; left: 10px; font-size: 0.8em; color: #718096;">Made By Cade Ward</div>

    <script>
        let currentSet = null;
        let currentCardIndex = 0;
        let isShowingFront = true;
        let savedSets = [];

        // Load saved sets from localStorage on page load
        function loadSavedSets() {
            try {
                const storedSets = localStorage.getItem('flashcardSets');
                if (storedSets) {
                    savedSets = JSON.parse(storedSets);
                }
            } catch (error) {
                console.error('Error loading sets from localStorage:', error);
                alert('Error loading saved sets. Please try again.');
            }
            updateWelcomeScreen();
        }

        function saveSetsToLocalStorage() {
            try {
                localStorage.setItem('flashcardSets', JSON.stringify(savedSets));
            } catch (error) {
                console.error('Error saving sets to localStorage:', error);
                alert('Error saving sets. Please try again.');
            }
        }

        function showWelcomeScreen() {
            hideAllScreens();
            document.getElementById('welcomeScreen').classList.remove('hidden');
            updateWelcomeScreen();
        }

        function showCreateScreen() {
            hideAllScreens();
            document.getElementById('createScreen').classList.remove('hidden');
            resetCreateForm();
        }

        function showStudyScreen(setData) {
            hideAllScreens();
            document.getElementById('studyScreen').classList.remove('hidden');
            startStudying(setData);
        }

        function hideAllScreens() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('createScreen').classList.add('hidden');
            document.getElementById('studyScreen').classList.add('hidden');
        }

        function updateWelcomeScreen() {
            const welcomeSets = document.getElementById('welcomeSets');
            const browseBtn = document.getElementById('browseBtn');
            
            if (savedSets.length === 0) {
                welcomeSets.innerHTML = '';
                browseBtn.style.display = 'none';
                return;
            }

            browseBtn.style.display = 'inline-block';
            
            // Clear existing content
            welcomeSets.innerHTML = '<h3 style="margin: 30px 0 20px 0; color: #4a5568;">Your Study Sets</h3>';
            
            savedSets.forEach((set, index) => {
                const setItem = document.createElement('div');
                setItem.className = 'set-item';
                
                const setInfo = document.createElement('div');
                setInfo.className = 'set-info';
                setInfo.innerHTML = `
                    <h3>${set.title}</h3>
                    <p>${set.cards.length} cards${set.description ? ' • ' + set.description : ''}</p>
                `;
                
                const setActions = document.createElement('div');
                setActions.className = 'set-actions';
                
                // Study button
                const studyBtn = document.createElement('button');
                studyBtn.className = 'btn';
                studyBtn.textContent = 'Study';
                studyBtn.addEventListener('click', () => showStudyScreen(savedSets[index]));
                
                // Edit button
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => showEditScreen(index));
                
                // Export button
                const exportBtn = document.createElement('button');
                exportBtn.className = 'btn btn-secondary';
                exportBtn.textContent = '💾 Export';
                exportBtn.addEventListener('click', () => exportSet(index));
                
                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-secondary';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => confirmDeleteSet(index));
                
                setActions.appendChild(studyBtn);
                setActions.appendChild(editBtn);
                setActions.appendChild(exportBtn);
                setActions.appendChild(deleteBtn);
                
                setItem.appendChild(setInfo);
                setItem.appendChild(setActions);
                welcomeSets.appendChild(setItem);
            });
        }

        function startStudyingSet(index) {
            showStudyScreen(savedSets[index]);
        }

        function confirmDeleteSet(index) {
            const setTitle = savedSets[index].title;
            if (confirm(`Are you sure you want to delete "${setTitle}"?\n\nThis action cannot be undone.`)) {
                savedSets.splice(index, 1);
                saveSetsToLocalStorage(); // Save to localStorage
                updateWelcomeScreen();
                alert(`"${setTitle}" has been deleted.`);
            }
        }

        function showCreateScreen() {
            hideAllScreens();
            document.getElementById('createScreen').classList.remove('hidden');
            resetCreateForm();
        }

        function resetCreateForm() {
            document.getElementById('setTitle').value = '';
            document.getElementById('setDescription').value = '';
            
            // Reset bulk import
            document.getElementById('bulkImportArea').classList.add('hidden');
            document.getElementById('bulkTextarea').value = '';
            document.getElementById('bulkImportToggle').textContent = '📝 Bulk Import';
            
            // Reset cards list
            const cardsList = document.getElementById('cardsList');
            cardsList.innerHTML = `
                <div class="cards-separator">Individual Cards</div>
                <div class="card-item">
                    <div class="card-inputs">
                        <div class="card-input-section">
                            <textarea class="card-input" placeholder="Enter the term or question" rows="3"></textarea>
                            <div class="image-controls">
                                <button class="image-btn" onclick="toggleImageInput(this, 'front')">📷 Add Image</button>
                            </div>
                        </div>
                        <div class="card-input-section">
                            <textarea class="card-input" placeholder="Enter the definition or answer" rows="3"></textarea>
                            <div class="image-controls">
                                <button class="image-btn" onclick="toggleImageInput(this, 'back')">📷 Add Image</button>
                            </div>
                        </div>
                    </div>
                    <button class="remove-card" onclick="removeCard(this)" style="display: none;">Remove</button>
                </div>
            `;
        }

        function toggleBulkImport() {
            const area = document.getElementById('bulkImportArea');
            const toggle = document.getElementById('bulkImportToggle');
            
            if (area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                toggle.textContent = '📝 Hide Bulk Import';
            } else {
                area.classList.add('hidden');
                toggle.textContent = '📝 Bulk Import';
            }
        }

        function clearBulkImport() {
            document.getElementById('bulkTextarea').value = '';
        }

        function processBulkImport() {
            const textarea = document.getElementById('bulkTextarea');
            const text = textarea.value.trim();

            if (!text) {
                alert('Please enter some text to import');
                return;
            }

            const { cards, failedLines } = parseBulkText(text);

            if (cards.length === 0) {
                alert('No valid cards found. Please check your format:\nUse: term/definition or term | definition');
                return;
            }

            // Clear existing cards and add imported ones
            const cardsList = document.getElementById('cardsList');
            let html = '<div class="cards-separator">Imported Cards</div>';

            cards.forEach((card, index) => {
                html += createCardItemHTML(card);
            });

            cardsList.innerHTML = html;
            updateRemoveButtons();

            // Clear and hide bulk import area
            textarea.value = '';
            document.getElementById('bulkImportArea').classList.add('hidden');
            document.getElementById('bulkImportToggle').textContent = '📝 Bulk Import';

            // Show results
            let message = `Successfully imported ${cards.length} cards!`;
            if (failedLines.length > 0) {
                message += `\n\nSkipped ${failedLines.length} lines with invalid format:\n${failedLines.join('\n')}`;
            }
            message += '\n\nYou can now edit the cards below or add more cards manually.';

            alert(message);
        }

        function parseBulkText(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const cards = [];
            const failedLines = [];

            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;

                // Try different separators: /, |, :, -
                let front = '', back = '';

                if (trimmedLine.includes('/')) {
                    [front, ...rest] = trimmedLine.split('/');
                    back = rest.join('/');
                } else if (trimmedLine.includes(' | ')) {
                    [front, ...rest] = trimmedLine.split(' | ');
                    back = rest.join(' | ');
                } else if (trimmedLine.includes(':')) {
                    [front, ...rest] = trimmedLine.split(':');
                    back = rest.join(':');
                } else if (trimmedLine.includes(' - ')) {
                    [front, ...rest] = trimmedLine.split(' - ');
                    back = rest.join(' - ');
                } else {
                    failedLines.push(`Line ${index + 1}: "${trimmedLine}"`);
                    return;
                }

                front = front.trim();
                back = back.trim();

                if (front && back) {
                    cards.push({ front, back });
                } else {
                    failedLines.push(`Line ${index + 1}: "${trimmedLine}"`);
                }
            });

            return { cards, failedLines };
        }

        function createCardItemHTML(card) {
            return `
                <div class="card-item">
                    <div class="card-inputs">
                        <div class="card-input-section">
                            <textarea class="card-input" rows="3">${card.front}</textarea>
                            <div class="image-controls">
                                <button class="image-btn" onclick="toggleImageInput(this, 'front')">📷 Add Image</button>
                            </div>
                        </div>
                        <div class="card-input-section">
                            <textarea class="card-input" rows="3">${card.back}</textarea>
                            <div class="image-controls">
                                <button class="image-btn" onclick="toggleImageInput(this, 'back')">📷 Add Image</button>
                            </div>
                        </div>
                    </div>
                    <button class="remove-card" onclick="removeCard(this)">Remove</button>
                </div>
            `;
        }

        function addCard() {
            const cardsList = document.getElementById('cardsList');
            const newCard = document.createElement('div');
            newCard.className = 'card-item';
            newCard.innerHTML = `
                <div class="card-inputs">
                    <div class="card-input-section">
                        <textarea class="card-input" placeholder="Enter the term or question" rows="3"></textarea>
                        <div class="image-controls">
                            <button class="image-btn" onclick="toggleImageInput(this, 'front')">📷 Add Image</button>
                        </div>
                    </div>
                    <div class="card-input-section">
                        <textarea class="card-input" placeholder="Enter the definition or answer" rows="3"></textarea>
                        <div class="image-controls">
                            <button class="image-btn" onclick="toggleImageInput(this, 'back')">📷 Add Image</button>
                        </div>
                    </div>
                </div>
                <button class="remove-card" onclick="removeCard(this)">Remove</button>
            `;
            
            // Add after the separator if it exists, or at the end
            const separator = cardsList.querySelector('.cards-separator');
            if (separator) {
                cardsList.appendChild(newCard);
            } else {
                // Add separator if we're adding the first manual card after bulk import
                const separatorDiv = document.createElement('div');
                separatorDiv.className = 'cards-separator';
                separatorDiv.textContent = 'Additional Cards';
                cardsList.appendChild(separatorDiv);
                cardsList.appendChild(newCard);
            }
            
            updateRemoveButtons();
        }

        function toggleImageInput(button, side) {
            const section = button.closest('.card-input-section');
            const existingInput = section.querySelector('.image-input');
            const existingPreview = section.querySelector('.image-preview');
            const existingFileInput = section.querySelector('.image-file-input');
            
            if (existingInput || existingPreview || existingFileInput) {
                // Remove existing image elements
                if (existingInput) existingInput.remove();
                if (existingPreview) existingPreview.remove();
                if (existingFileInput) existingFileInput.remove();
                const removeBtn = section.querySelector('.remove-image');
                if (removeBtn) removeBtn.remove();
                
                button.textContent = '📷 Add Image';
                button.classList.remove('active');
                return;
            }
            
            // Create image options
            const imageOptions = document.createElement('div');
            imageOptions.className = 'image-controls';
            imageOptions.style.marginTop = '8px';
            imageOptions.innerHTML = `
                <button class="image-btn" onclick="showUrlInput(this)">🔗 URL</button>
                <button class="image-btn" onclick="showFileInput(this)">📁 Upload</button>
                <button class="image-btn" onclick="cancelImageAdd(this)">❌ Cancel</button>
            `;
            
            section.appendChild(imageOptions);
            button.textContent = '📷 Adding...';
            button.classList.add('active');
        }

        function showUrlInput(button) {
            const section = button.closest('.card-input-section');
            const optionsDiv = button.closest('.image-controls');
            
            const urlInput = document.createElement('input');
            urlInput.type = 'url';
            urlInput.className = 'image-input';
            urlInput.placeholder = 'Enter image URL (https://...)';
            urlInput.addEventListener('input', function() {
                previewImageFromUrl(this);
            });
            
            optionsDiv.replaceWith(urlInput);
        }

        function showFileInput(button) {
            const section = button.closest('.card-input-section');
            const optionsDiv = button.closest('.image-controls');
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.className = 'image-file-input';
            fileInput.accept = 'image/*';
            fileInput.addEventListener('change', function() {
                previewImageFromFile(this);
            });
            
            optionsDiv.replaceWith(fileInput);
            fileInput.click();
        }

        function cancelImageAdd(button) {
            const section = button.closest('.card-input-section');
            const optionsDiv = button.closest('.image-controls');
            const addButton = section.querySelector('.image-btn');
            
            optionsDiv.remove();
            addButton.textContent = '📷 Add Image';
            addButton.classList.remove('active');
        }

        function previewImageFromUrl(input) {
            const section = input.closest('.card-input-section');
            const existingPreview = section.querySelector('.image-preview');
            const existingRemoveBtn = section.querySelector('.remove-image');
            
            if (existingPreview) existingPreview.remove();
            if (existingRemoveBtn) existingRemoveBtn.remove();
            
            if (input.value.trim()) {
                const img = document.createElement('img');
                img.className = 'image-preview';
                img.src = input.value.trim();
                img.onerror = function() {
                    this.style.border = '2px solid #e53e3e';
                    this.alt = 'Failed to load image';
                };
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-image';
                removeBtn.textContent = 'Remove Image';
                removeBtn.onclick = function() {
                    removeImage(this);
                };
                
                section.appendChild(img);
                section.appendChild(removeBtn);
                
                // Update the add button
                const addButton = section.querySelector('.image-btn');
                addButton.textContent = '📷 Image Added';
                addButton.classList.add('active');
            }
        }

        function previewImageFromFile(input) {
            const section = input.closest('.card-input-section');
            const file = input.files[0];
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const existingPreview = section.querySelector('.image-preview');
                    const existingRemoveBtn = section.querySelector('.remove-image');
                    
                    if (existingPreview) existingPreview.remove();
                    if (existingRemoveBtn) existingRemoveBtn.remove();
                    
                    const img = document.createElement('img');
                    img.className = 'image-preview';
                    img.src = e.target.result;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-image';
                    removeBtn.textContent = 'Remove Image';
                    removeBtn.onclick = function() {
                        removeImage(this);
                    };
                    
                    section.appendChild(img);
                    section.appendChild(removeBtn);
                    
                    // Update the add button
                    const addButton = section.querySelector('.image-btn');
                    addButton.textContent = '📷 Image Added';
                    addButton.classList.add('active');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage(button) {
            const section = button.closest('.card-input-section');
            const preview = section.querySelector('.image-preview');
            const input = section.querySelector('.image-input, .image-file-input');
            const addButton = section.querySelector('.image-btn');
            
            if (preview) preview.remove();
            if (input) input.remove();
            button.remove();
            
            addButton.textContent = '📷 Add Image';
            addButton.classList.remove('active');
        }

        function removeCard(button) {
            button.parentElement.remove();
            updateRemoveButtons();
        }

        function updateRemoveButtons() {
            const cards = document.querySelectorAll('.card-item');
            const removeButtons = document.querySelectorAll('.remove-card');
            
            removeButtons.forEach(btn => {
                btn.style.display = cards.length > 1 ? 'inline-block' : 'none';
            });
        }

        function saveSet() {
            const title = document.getElementById('setTitle').value.trim();
            const description = document.getElementById('setDescription').value.trim();
            const cardItems = document.querySelectorAll('.card-item');
            
            if (!title) {
                alert('Please enter a title for your set');
                return;
            }
            
            const cards = [];
            let hasEmptyCard = false;
            
            cardItems.forEach(item => {
                const sections = item.querySelectorAll('.card-input-section');
                if (sections.length === 2) {
                    // New format with image support
                    const frontSection = sections[0];
                    const backSection = sections[1];
                    
                    const front = frontSection.querySelector('.card-input').value.trim();
                    const back = backSection.querySelector('.card-input').value.trim();
                    
                    const frontImg = frontSection.querySelector('.image-preview');
                    const backImg = backSection.querySelector('.image-preview');
                    
                    if (front || back || frontImg || backImg) {
                        const card = { front, back };
                        
                        if (frontImg) {
                            card.frontImage = frontImg.src;
                        }
                        if (backImg) {
                            card.backImage = backImg.src;
                        }
                        
                        cards.push(card);
                    } else {
                        hasEmptyCard = true;
                    }
                } else {
                    // Old format without image support (for bulk imported cards)
                    const inputs = item.querySelectorAll('.card-input');
                    if (inputs.length >= 2) {
                        const front = inputs[0].value.trim();
                        const back = inputs[1].value.trim();
                        
                        if (front && back) {
                            cards.push({ front, back });
                        } else if (front || back) {
                            hasEmptyCard = true;
                        }
                    }
                }
            });
            
            if (cards.length === 0) {
                alert('Please add at least one complete card');
                return;
            }
            
            if (hasEmptyCard) {
                if (!confirm('Some cards are incomplete and will be skipped. Continue saving?')) {
                    return;
                }
            }
            
            const newSet = {
                title,
                description,
                cards,
                created: new Date().toLocaleDateString()
            };
            
            savedSets.push(newSet);
            saveSetsToLocalStorage(); // Save to localStorage
            alert(`Set "${title}" saved with ${cards.length} cards!`);
            showWelcomeScreen();
        }

        function deleteSet(index) {
            // This function is now replaced by confirmDeleteSet for better UX
            confirmDeleteSet(index);
        }

        function shuffleCards() {
            if (!currentSet || currentSet.cards.length <= 1) return;
            
            // Fisher-Yates shuffle algorithm
            const shuffled = [...currentSet.cards];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            currentSet.cards = shuffled;
            currentCardIndex = 0;
            isShowingFront = true;
            
            updateCard();
            updateProgress();
            updateNavigationButtons();
            
            // Brief visual feedback
            const shuffleBtn = document.getElementById('shuffleBtn');
            const originalText = shuffleBtn.textContent;
            shuffleBtn.textContent = '✨ Shuffled!';
            shuffleBtn.style.background = '#38a169';
            
            setTimeout(() => {
                shuffleBtn.textContent = originalText;
                shuffleBtn.style.background = '#4299e1';
            }, 1000);
        }

        function exportSet(index) {
            const set = savedSets[index];
            const dataStr = JSON.stringify(set, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${set.title.replace(/[^a-z0-9]/gi, '_')}_flashcards.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            setTimeout(() => {
                alert(`"${set.title}" exported successfully!\n\nFile saved as: ${link.download}`);
            }, 100);
        }

        function triggerImportFile() {
            document.getElementById('fileImport').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    if (file.name.endsWith('.json')) {
                        // Handle JSON format
                        const importedSet = JSON.parse(content);
                        
                        // Validate the structure
                        if (!importedSet.title || !Array.isArray(importedSet.cards)) {
                            throw new Error('Invalid file format. Expected JSON with title and cards array.');
                        }
                        
                        // Validate cards
                        const validCards = importedSet.cards.filter(card => 
                            card && typeof card.front === 'string' && typeof card.back === 'string'
                        );
                        
                        if (validCards.length === 0) {
                            throw new Error('No valid cards found in file.');
                        }
                        
                        // Add to saved sets
                        const newSet = {
                            title: importedSet.title,
                            description: importedSet.description || '',
                            cards: validCards,
                            created: new Date().toLocaleDateString(),
                            imported: true
                        };
                        
                        savedSets.push(newSet);
                        updateWelcomeScreen();
                        
                        alert(`Successfully imported "${newSet.title}" with ${validCards.length} cards!`);
                        
                    } else if (file.name.endsWith('.txt')) {
                        // Handle text format - use same logic as bulk import
                        const lines = content.split('\n').filter(line => line.trim());
                        const cards = [];
                        
                        lines.forEach(line => {
                            const trimmedLine = line.trim();
                            if (!trimmedLine) return;
                            
                            let front = '', back = '';
                            
                            if (trimmedLine.includes('/')) {
                                [front, ...rest] = trimmedLine.split('/');
                                back = rest.join('/');
                            } else if (trimmedLine.includes(' | ')) {
                                [front, ...rest] = trimmedLine.split(' | ');
                                back = rest.join(' | ');
                            } else if (trimmedLine.includes(':')) {
                                [front, ...rest] = trimmedLine.split(':');
                                back = rest.join(':');
                            } else if (trimmedLine.includes(' - ')) {
                                [front, ...rest] = trimmedLine.split(' - ');
                                back = rest.join(' - ');
                            }
                            
                            front = front.trim();
                            back = back.trim();
                            
                            if (front && back) {
                                cards.push({ front, back });
                            }
                        });
                        
                        if (cards.length === 0) {
                            throw new Error('No valid cards found. Please use format: term/definition');
                        }
                        
                        const fileName = file.name.replace(/\.[^/.]+$/, '');
                        const newSet = {
                            title: fileName,
                            description: `Imported from ${file.name}`,
                            cards: cards,
                            created: new Date().toLocaleDateString(),
                            imported: true
                        };
                        
                        savedSets.push(newSet);
                        updateWelcomeScreen();
                        
                        alert(`Successfully imported "${newSet.title}" with ${cards.length} cards from text file!`);
                    }
                    
                } catch (error) {
                    alert(`Error importing file: ${error.message}\n\nFor JSON files: Ensure the file contains a valid flashcard set.\nFor text files: Use format "term/definition" one per line.`);
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function handleCreateFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    if (file.name.endsWith('.json')) {
                        const importedSet = JSON.parse(content);
                        
                        if (!importedSet.title || !Array.isArray(importedSet.cards)) {
                            throw new Error('Invalid JSON format');
                        }
                        
                        // Fill the form with imported data
                        document.getElementById('setTitle').value = importedSet.title;
                        document.getElementById('setDescription').value = importedSet.description || '';
                        
                        // Clear existing cards and populate with imported ones
                        const cardsList = document.getElementById('cardsList');
                        let html = '<div class="cards-separator">Imported Cards</div>';
                        
                        importedSet.cards.forEach(card => {
                            if (card.front || card.back || card.frontImage || card.backImage) {
                                html += `
                                    <div class="card-item">
                                        <div class="card-inputs">
                                            <div class="card-input-section">
                                                <textarea class="card-input" rows="3">${card.front || ''}</textarea>
                                                <div class="image-controls">
                                                    <button class="image-btn ${card.frontImage ? 'active' : ''}" onclick="toggleImageInput(this, 'front')">${card.frontImage ? '📷 Image Added' : '📷 Add Image'}</button>
                                                </div>
                                                ${card.frontImage ? `<img class="image-preview" src="${card.frontImage}" alt="Front image"><button class="remove-image" onclick="removeImage(this)">Remove Image</button>` : ''}
                                            </div>
                                            <div class="card-input-section">
                                                <textarea class="card-input" rows="3">${card.back || ''}</textarea>
                                                <div class="image-controls">
                                                    <button class="image-btn ${card.backImage ? 'active' : ''}" onclick="toggleImageInput(this, 'back')">${card.backImage ? '📷 Image Added' : '📷 Add Image'}</button>
                                                </div>
                                                ${card.backImage ? `<img class="image-preview" src="${card.backImage}" alt="Back image"><button class="remove-image" onclick="removeImage(this)">Remove Image</button>` : ''}
                                            </div>
                                        </div>
                                        <button class="remove-card" onclick="removeCard(this)">Remove</button>
                                    </div>
                                `;
                            }
                        });
                        
                        cardsList.innerHTML = html;
                        updateRemoveButtons();
                        
                        alert(`Imported "${importedSet.title}" for editing!\nYou can now modify the cards and save as a new set.`);
                        
                    } else if (file.name.endsWith('.txt')) {
                        // Use bulk import logic for text files
                        const textarea = document.getElementById('bulkTextarea');
                        textarea.value = content;
                        
                        // Show bulk import area if hidden
                        document.getElementById('bulkImportArea').classList.remove('hidden');
                        document.getElementById('bulkImportToggle').textContent = '📝 Hide Bulk Import';
                        
                        // Auto-fill title from filename
                        if (!document.getElementById('setTitle').value) {
                            const fileName = file.name.replace(/\.[^/.]+$/, '');
                            document.getElementById('setTitle').value = fileName;
                        }
                        
                        alert(`Text file loaded into bulk import area.\nClick "Import Cards" to process the content.`);
                    }
                    
                } catch (error) {
                    alert(`Error loading file: ${error.message}`);
                }
                
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function startStudying(setData) {
            currentSet = setData;
            currentCardIndex = 0;
            isShowingFront = true;
            
            document.getElementById('studyTitle').textContent = setData.title;
            updateCard();
            updateProgress();
            updateNavigationButtons();
        }

        function updateCard() {
            if (!currentSet || currentSet.cards.length === 0) return;
            
            const card = currentSet.cards[currentCardIndex];
            const contentDiv = document.getElementById('cardContent');
            
            // Clear previous content
            contentDiv.innerHTML = '';
            
            if (isShowingFront) {
                // Show front content
                if (card.frontImage) {
                    const img = document.createElement('img');
                    img.className = 'card-image';
                    img.src = card.frontImage;
                    img.alt = 'Front image';
                    contentDiv.appendChild(img);
                }
                
                if (card.front) {
                    const textDiv = document.createElement('div');
                    textDiv.className = 'card-text';
                    textDiv.textContent = card.front;
                    contentDiv.appendChild(textDiv);
                }
                
                if (!card.front && !card.frontImage) {
                    contentDiv.textContent = '(No front content)';
                }
            } else {
                // Show back content
                if (card.backImage) {
                    const img = document.createElement('img');
                    img.className = 'card-image';
                    img.src = card.backImage;
                    img.alt = 'Back image';
                    contentDiv.appendChild(img);
                }
                
                if (card.back) {
                    const textDiv = document.createElement('div');
                    textDiv.className = 'card-text';
                    textDiv.textContent = card.back;
                    contentDiv.appendChild(textDiv);
                }
                
                if (!card.back && !card.backImage) {
                    contentDiv.textContent = '(No back content)';
                }
            }
            
            const indicator = document.getElementById('flipIndicator');
            indicator.textContent = `Showing: ${isShowingFront ? 'Front' : 'Back'}`;
        }

        function updateProgress() {
            if (!currentSet) return;
            document.getElementById('progress').textContent = 
                `${currentCardIndex + 1} / ${currentSet.cards.length}`;
        }

        function updateNavigationButtons() {
            if (!currentSet) return;
            
            document.getElementById('prevBtn').disabled = currentCardIndex === 0;
            document.getElementById('nextBtn').disabled = currentCardIndex === currentSet.cards.length - 1;
        }

        function flipCard() {
            if (!currentSet) return;
            isShowingFront = !isShowingFront;
            updateCard();
        }

        function previousCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                isShowingFront = true;
                updateCard();
                updateProgress();
                updateNavigationButtons();
            }
        }

        function nextCard() {
            if (currentCardIndex < currentSet.cards.length - 1) {
                currentCardIndex++;
                isShowingFront = true;
                updateCard();
                updateProgress();
                updateNavigationButtons();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('studyScreen').classList.contains('hidden')) return;
            
            if (e.code === 'Space' || e.code === 'Enter') {
                e.preventDefault();
                flipCard();
            } else if (e.code === 'ArrowLeft') {
                e.preventDefault();
                previousCard();
            } else if (e.code === 'ArrowRight') {
                e.preventDefault();
                nextCard();
            } else if (e.code === 'KeyS' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                shuffleCards();
            }
        });

        // Initialize app
        loadSavedSets();
    </script>
</body>
</html>