<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">
    <title>FlashinStudy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1em;
            opacity: 0.9;
        }

        /* Screen Layout */
        .screen {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 60px 40px;
        }

        .welcome-screen h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .welcome-screen p {
            font-size: 1.1em;
            color: #718096;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        /* Set Management */
        .sets-list {
            margin-top: 20px;
        }

        .set-item {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .set-item:hover {
            border-color: #cbd5e0;
            transform: translateY(-2px);
        }

        .set-info h3 {
            color: #2d3748;
            margin-bottom: 5px;
        }

        .set-info p {
            color: #718096;
            font-size: 0.9em;
        }

        .set-actions {
            display: flex;
            gap: 10px;
        }

        /* Form Elements */
        .set-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #4a5568;
        }

        .set-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .set-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Card Creation */
        .card-item {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .card-item:hover {
            border-color: #cbd5e0;
            transform: translateY(-2px);
        }

        .card-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .card-input-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card-input {
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1em;
            resize: vertical;
            min-height: 60px;
            transition: border-color 0.3s ease;
        }

        .card-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Image Handling */
        .image-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .image-btn {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-btn:hover {
            background: #cbd5e0;
        }

        .image-btn.active {
            background: #667eea;
            color: white;
        }

        .image-input {
            margin-top: 8px;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .image-preview {
            margin-top: 10px;
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            object-fit: cover;
        }

        .remove-image {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            margin-top: 5px;
            transition: background-color 0.3s ease;
        }

        .remove-image:hover {
            background: #c53030;
        }

        /* Bulk Import */
        .bulk-import-section {
            margin-bottom: 25px;
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 20px;
            background: #f8fafc;
            transition: all 0.3s ease;
        }

        .bulk-import-section:hover {
            border-color: #a0aec0;
        }

        .import-toggle {
            text-align: center;
            margin-bottom: 15px;
        }

        .import-instructions {
            background: #edf2f7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.95em;
        }

        .import-instructions p {
            margin-bottom: 8px;
            color: #4a5568;
        }

        .import-instructions code {
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #2d3748;
        }

        .bulk-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.95em;
            resize: vertical;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .bulk-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .import-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .cards-separator {
            text-align: center;
            margin: 20px 0;
            color: #718096;
            font-weight: 500;
        }

        .cards-separator::before,
        .cards-separator::after {
            content: '';
            display: inline-block;
            width: 60px;
            height: 1px;
            background: #cbd5e0;
            vertical-align: middle;
            margin: 0 15px;
        }

        /* Study Screen */
        .study-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .study-title {
            font-size: 1.8em;
            color: #2d3748;
        }

        .progress {
            font-size: 1.1em;
            color: #718096;
        }

        .flashcard {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            perspective: 1000px;
        }

        .flashcard:hover {
            border-color: #cbd5e0;
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .card-content {
            text-align: center;
            padding: 40px;
            font-size: 1.3em;
            line-height: 1.5;
            word-wrap: break-word;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .card-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            object-fit: contain;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .card-text {
            flex: 1;
        }

        .card-flip-hint {
            position: absolute;
            bottom: 15px;
            right: 20px;
            color: #a0aec0;
            font-size: 0.9em;
        }

        .flip-indicator {
            text-align: center;
            margin: 20px 0;
            color: #718096;
            font-style: italic;
        }

        .study-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        /* Buttons */
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .btn-success {
            background: #38a169;
        }

        .btn-success:hover {
            background: #2f855a;
        }

        .remove-card {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .remove-card:hover {
            background: #c53030;
        }

        .nav-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .button-container {
            text-align: center;
            margin-top: 30px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .card-inputs {
                grid-template-columns: 1fr;
            }
            
            .study-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .study-controls {
                flex-direction: column;
                align-items: center;
            }

            .nav-btn {
                width: 100%;
                max-width: 200px;
            }

            .import-actions {
                flex-direction: column;
            }

            .set-item {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .set-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* Attribution */
        .attribution {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 0.8em;
            color: white;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 Flashiest Cards</h1>
            <p style="opacity: 0.9; margin-top: 5px;">Create, study, and master your flashcards • Part of the FlashCard Suite</p>
        </div>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen">
            <div class="welcome-screen">
                <h2>Get Studying Done in a Flash</h2>
                <p>Create flashcard sets and study them with an intuitive interface. Start by creating your first set.</p>
                <div class="button-container">
                    <button class="btn btn-success" onclick="showCreateScreen()">+ Create New Set</button>
                    <button class="btn" onclick="triggerImportFile()">📁 Import Set</button>
                    <button class="btn" onclick="openTestApp()" style="background: #3182ce;">🧠 Test Yourself</button>
                </div>
                <input type="file" id="fileImport" accept=".json,.txt" style="display: none;" onchange="handleFileImport(event)">
            </div>
            <div class="sets-list" id="welcomeSets"></div>
        </div>

        <!-- Create Set Screen -->
        <div id="createScreen" class="screen hidden">
            <div class="set-title">Create a New Flashcard Set</div>
            
            <input type="text" class="set-input" id="setTitle" placeholder="Enter a title for your set (e.g., 'Spanish Vocabulary', 'History Terms')">
            <input type="text" class="set-input" id="setDescription" placeholder="Add a description (optional)">
            
            <!-- Bulk Import Section -->
            <div class="bulk-import-section" id="bulkImportSection">
                <div class="import-toggle">
                    <button class="btn btn-secondary" onclick="toggleBulkImport()" id="bulkImportToggle">📝 Bulk Import</button>
                </div>
                <div class="bulk-import-area hidden" id="bulkImportArea">
                    <div class="import-instructions">
                        <p><strong>Quick Import:</strong> Paste your terms and definitions, one per line</p>
                        <p><strong>Format:</strong> <code>term/definition</code> or <code>term | definition</code></p>
                        <p><em>Example:</em> <code>apple/a red fruit</code></p>
                    </div>
                    <textarea class="bulk-textarea" id="bulkTextarea" 
                        placeholder="apple/a red fruit&#10;cat/a small domestic animal&#10;run/to move quickly on foot&#10;&#10;Paste your content here..."></textarea>
                    <div class="import-actions">
                        <button class="btn" onclick="processBulkImport()">Import Cards</button>
                        <button class="btn btn-secondary" onclick="clearBulkImport()">Clear</button>
                    </div>
                </div>
            </div>
            
            <div id="cardsList">
                <div class="cards-separator">Individual Cards</div>
                <div class="card-item">
                    <div class="card-inputs">
                        <div class="card-input-section">
                            <textarea class="card-input" placeholder="Enter the term or question" rows="3"></textarea>
                            <div class="image-controls">
                                <button class="image-btn" onclick="toggleImageInput(this, 'front')">📷 Add Image</button>
                            </div>
                        </div>
                        <div class="card-input-section">
                            <textarea class="card-input" placeholder="Enter the definition or answer" rows="3"></textarea>
                            <div class="image-controls">
                                <button class="image-btn" onclick="toggleImageInput(this, 'back')">📷 Add Image</button>
                            </div>
                        </div>
                    </div>
                    <button class="remove-card" onclick="removeCard(this)" style="display: none;">Remove</button>
                </div>
            </div>

            <div class="button-container">
                <button class="btn" onclick="addCard()">+ Add Card</button>
                <button class="btn" onclick="triggerCreateImportFile()">📁 Import from File</button>
                <button class="btn btn-success" onclick="saveSet()">Save Set</button>
                <button class="btn btn-secondary" onclick="showWelcomeScreen()">Cancel</button>
            </div>
            
            <input type="file" id="createFileImport" accept=".json,.txt" style="display: none;" onchange="handleCreateFileImport(event)">
        </div>

        <!-- Study Screen -->
        <div id="studyScreen" class="screen hidden">
            <div class="study-header">
                <h2 class="study-title" id="studyTitle">Study Set</h2>
                <div class="progress" id="progress">1 / 10</div>
            </div>

            <div class="flashcard" id="flashcard" onclick="flipCard()">
                <div class="card-content" id="cardContent">Click to start studying</div>
                <div class="card-flip-hint">Click to flip</div>
            </div>

            <div class="flip-indicator" id="flipIndicator">Showing: Front</div>

            <div class="study-controls">
                <button class="nav-btn" id="prevBtn" onclick="previousCard()" disabled>← Previous</button>
                <button class="nav-btn" onclick="shuffleCards()" id="shuffleBtn">🔀 Shuffle</button>
                <button class="btn btn-secondary" onclick="showWelcomeScreen()">← Back to Sets</button>
                <button class="nav-btn" id="nextBtn" onclick="nextCard()">Next →</button>
            </div>
        </div>
    </div>

    <div class="attribution">Made by Cade Ward</div>

    <script>
        // ===== GLOBAL STATE =====
        let currentSet = null;
        let currentCardIndex = 0;
        let isShowingFront = true;
        let savedSets = [];
        let editingIndex = null;

        // ===== INITIALIZATION =====
        function initializeApp() {
            loadSavedSets();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // Add update buttons visibility on load
            updateRemoveButtons();
        }

        function handleKeyboardShortcuts(e) {
            if (document.getElementById('studyScreen').classList.contains('hidden')) return;
            
            switch(e.code) {
                case 'Space':
                case 'Enter':
                    e.preventDefault();
                    flipCard();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    previousCard();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextCard();
                    break;
                case 'KeyS':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        shuffleCards();
                    }
                    break;
            }
        }

        // ===== DATA PERSISTENCE =====
        function loadSavedSets() {
            try {
                const storedSets = localStorage.getItem('flashcardSets');
                savedSets = storedSets ? JSON.parse(storedSets) : [];
                updateWelcomeScreen();
            } catch (error) {
                console.error('Error loading sets:', error);
                showErrorMessage('Error loading saved sets. Please try again.');
                savedSets = [];
            }
        }

        function saveSetsToStorage() {
            try {
                localStorage.setItem('flashcardSets', JSON.stringify(savedSets));
            } catch (error) {
                console.error('Error saving sets:', error);
                showErrorMessage('Error saving sets. Please try again.');
            }
        }

        // ===== SCREEN NAVIGATION =====
        function showWelcomeScreen() {
            hideAllScreens();
            document.getElementById('welcomeScreen').classList.remove('hidden');
            updateWelcomeScreen();
            resetEditState();
        }

        function showCreateScreen() {
            hideAllScreens();
            document.getElementById('createScreen').classList.remove('hidden');
            resetCreateForm();
        }

        function showStudyScreen(setData) {
            hideAllScreens();
            document.getElementById('studyScreen').classList.remove('hidden');
            startStudying(setData);
        }

        function hideAllScreens() {
            const screens = ['welcomeScreen', 'createScreen', 'studyScreen'];
            screens.forEach(screenId => {
                document.getElementById(screenId).classList.add('hidden');
            });
        }

        // ===== WELCOME SCREEN MANAGEMENT =====
        function updateWelcomeScreen() {
            const welcomeSets = document.getElementById('welcomeSets');
            
            if (savedSets.length === 0) {
                welcomeSets.innerHTML = '';
                return;
            }

            welcomeSets.innerHTML = '<h3 style="margin: 30px 0 20px 0; color: #4a5568;">Your Study Sets</h3>';
            
            savedSets.forEach((set, index) => {
                const setItem = createSetElement(set, index);
                welcomeSets.appendChild(setItem);
            });
        }

        function createSetElement(set, index) {
            const setItem = document.createElement('div');
            setItem.className = 'set-item';
            
            setItem.innerHTML = `
                <div class="set-info">
                    <h3>${escapeHtml(set.title)}</h3>
                    <p>${set.cards.length} cards${set.description ? ' • ' + escapeHtml(set.description) : ''}</p>
                </div>
                <div class="set-actions">
                    <button class="btn" onclick="showStudyScreen(savedSets[${index}])">Study</button>
                    <button class="btn" onclick="testSet(${index})" style="background: #3182ce;">🧠 Test</button>
                    <button class="btn btn-secondary" onclick="showEditScreen(${index})">Edit</button>
                    <button class="btn btn-secondary" onclick="exportSet(${index})">💾 Export</button>
                    <button class="btn btn-secondary" onclick="confirmDeleteSet(${index})">Delete</button>
                </div>
            `;
            
            return setItem;
        }

        // ===== CREATE/EDIT FORM MANAGEMENT =====
        function resetCreateForm() {
            document.getElementById('setTitle').value = '';
            document.getElementById('setDescription').value = '';
            
            // Reset bulk import
            const bulkArea = document.getElementById('bulkImportArea');
            bulkArea.classList.add('hidden');
            document.getElementById('bulkTextarea').value = '';
            document.getElementById('bulkImportToggle').textContent = '📝 Bulk Import';
            
            // Reset cards list
            resetCardsList();
            resetSaveButton();
        }

        function resetCardsList() {
            document.getElementById('cardsList').innerHTML = `
                <div class="cards-separator">Individual Cards</div>
                <div class="card-item">
                    <div class="card-inputs">
                        <div class="card-input-section">
                            <textarea class="card-input" placeholder="Enter the term or question" rows="3"></textarea>
                            <div class="image-controls">
                                <button class="image-btn" onclick="toggleImageInput(this, 'front')">📷 Add Image</button>
                            </div>
                        </div>
                        <div class="card-input-section">
                            <textarea class="card-input" placeholder="Enter the definition or answer" rows="3"></textarea>
                            <div class="image-controls">
                                <button class="image-btn" onclick="toggleImageInput(this, 'back')">📷 Add Image</button>
                            </div>
                        </div>
                    </div>
                    <button class="remove-card" onclick="removeCard(this)" style="display: none;">Remove</button>
                </div>
            `;
            updateRemoveButtons();
        }

        function resetSaveButton() {
            const saveButton = document.querySelector('#createScreen .btn-success');
            saveButton.textContent = 'Save Set';
            saveButton.onclick = saveSet;
        }

        function resetEditState() {
            editingIndex = null;
            resetSaveButton();
        }

        // ===== BULK IMPORT =====
        function toggleBulkImport() {
            const area = document.getElementById('bulkImportArea');
            const toggle = document.getElementById('bulkImportToggle');
            
            if (area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                toggle.textContent = '📝 Hide Bulk Import';
            } else {
                area.classList.add('hidden');
                toggle.textContent = '📝 Bulk Import';
            }
        }

        function clearBulkImport() {
            document.getElementById('bulkTextarea').value = '';
        }

        function processBulkImport() {
            const text = document.getElementById('bulkTextarea').value.trim();
            
            if (!text) {
                showErrorMessage('Please enter some text to import');
                return;
            }

            const { cards, failedLines } = parseBulkText(text);

            if (cards.length === 0) {
                showErrorMessage('No valid cards found. Please check your format:\nUse: term/definition or term | definition');
                return;
            }

            // Clear existing cards and add imported ones
            populateCardsFromBulk(cards);
            hideBulkImport();
            showBulkImportResults(cards.length, failedLines);
        }

        function parseBulkText(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const cards = [];
            const failedLines = [];

            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;

                const separators = ['/', ' | ', ':', ' - '];
                let front = '', back = '';
                let parsed = false;

                for (const sep of separators) {
                    if (trimmedLine.includes(sep)) {
                        const parts = trimmedLine.split(sep);
                        front = parts[0].trim();
                        back = parts.slice(1).join(sep).trim();
                        parsed = true;
                        break;
                    }
                }

                if (parsed && front && back) {
                    cards.push({ front, back });
                } else {
                    failedLines.push(`Line ${index + 1}: "${trimmedLine}"`);
                }
            });

            return { cards, failedLines };
        }

        function populateCardsFromBulk(cards) {
            const cardsList = document.getElementById('cardsList');
            let html = '<div class="cards-separator">Imported Cards</div>';

            cards.forEach(card => {
                html += createCardItemHTML(card);
            });

            cardsList.innerHTML = html;
            updateRemoveButtons();
        }

        function hideBulkImport() {
            document.getElementById('bulkTextarea').value = '';
            document.getElementById('bulkImportArea').classList.add('hidden');
            document.getElementById('bulkImportToggle').textContent = '📝 Bulk Import';
        }

        function showBulkImportResults(successCount, failedLines) {
            let message = `Successfully imported ${successCount} cards!`;
            if (failedLines.length > 0) {
                message += `\n\nSkipped ${failedLines.length} lines with invalid format:\n${failedLines.join('\n')}`;
            }
            message += '\n\nYou can now edit the cards below or add more cards manually.';
            alert(message);
        }

        // ===== CARD MANAGEMENT =====
        function addCard() {
            const cardsList = document.getElementById('cardsList');
            const newCard = document.createElement('div');
            newCard.className = 'card-item';
            newCard.innerHTML = createEmptyCardHTML();
            
            // Add after separator or at the end
            const separator = cardsList.querySelector('.cards-separator');
            if (separator) {
                cardsList.appendChild(newCard);
            } else {
                const separatorDiv = document.createElement('div');
                separatorDiv.className = 'cards-separator';
                separatorDiv.textContent = 'Additional Cards';
                cardsList.appendChild(separatorDiv);
                cardsList.appendChild(newCard);
            }
            
            updateRemoveButtons();
        }

        function createEmptyCardHTML() {
            return `
                <div class="card-inputs">
                    <div class="card-input-section">
                        <textarea class="card-input" placeholder="Enter the term or question" rows="3"></textarea>
                        <div class="image-controls">
                            <button class="image-btn" onclick="toggleImageInput(this, 'front')">📷 Add Image</button>
                        </div>
                    </div>
                    <div class="card-input-section">
                        <textarea class="card-input" placeholder="Enter the definition or answer" rows="3"></textarea>
                        <div class="image-controls">
                            <button class="image-btn" onclick="toggleImageInput(this, 'back')">📷 Add Image</button>
                        </div>
                    </div>
                </div>
                <button class="remove-card" onclick="removeCard(this)">Remove</button>
            `;
        }

        function createCardItemHTML(card) {
            return `
                <div class="card-item">
                    <div class="card-inputs">
                        <div class="card-input-section">
                            <textarea class="card-input" rows="3">${escapeHtml(card.front || '')}</textarea>
                            <div class="image-controls">
                                <button class="image-btn ${card.frontImage ? 'active' : ''}" onclick="toggleImageInput(this, 'front')">
                                    ${card.frontImage ? '📷 Image Added' : '📷 Add Image'}
                                </button>
                            </div>
                            ${card.frontImage ? `
                                <img class="image-preview" src="${escapeHtml(card.frontImage)}" alt="Front image">
                                <button class="remove-image" onclick="removeImage(this)">Remove Image</button>
                            ` : ''}
                        </div>
                        <div class="card-input-section">
                            <textarea class="card-input" rows="3">${escapeHtml(card.back || '')}</textarea>
                            <div class="image-controls">
                                <button class="image-btn ${card.backImage ? 'active' : ''}" onclick="toggleImageInput(this, 'back')">
                                    ${card.backImage ? '📷 Image Added' : '📷 Add Image'}
                                </button>
                            </div>
                            ${card.backImage ? `
                                <img class="image-preview" src="${escapeHtml(card.backImage)}" alt="Back image">
                                <button class="remove-image" onclick="removeImage(this)">Remove Image</button>
                            ` : ''}
                        </div>
                    </div>
                    <button class="remove-card" onclick="removeCard(this)">Remove</button>
                </div>
            `;
        }

        function removeCard(button) {
            button.parentElement.remove();
            updateRemoveButtons();
        }

        function updateRemoveButtons() {
            const cards = document.querySelectorAll('.card-item');
            const removeButtons = document.querySelectorAll('.remove-card');
            
            removeButtons.forEach(btn => {
                btn.style.display = cards.length > 1 ? 'inline-block' : 'none';
            });
        }

        // ===== IMAGE HANDLING =====
        function toggleImageInput(button, side) {
            const section = button.closest('.card-input-section');
            const existingElements = section.querySelectorAll('.image-input, .image-preview, .image-file-input, .remove-image');
            
            if (existingElements.length > 0) {
                // Remove existing image elements
                existingElements.forEach(el => el.remove());
                button.textContent = '📷 Add Image';
                button.classList.remove('active');
                return;
            }
            
            // Create image options
            const imageOptions = document.createElement('div');
            imageOptions.className = 'image-controls';
            imageOptions.style.marginTop = '8px';
            imageOptions.innerHTML = `
                <button class="image-btn" onclick="showUrlInput(this)">🔗 URL</button>
                <button class="image-btn" onclick="showFileInput(this)">📄 Upload</button>
                <button class="image-btn" onclick="cancelImageAdd(this)">❌ Cancel</button>
            `;
            
            section.appendChild(imageOptions);
            button.textContent = '📷 Adding...';
            button.classList.add('active');
        }

        function showUrlInput(button) {
            const section = button.closest('.card-input-section');
            const optionsDiv = button.closest('.image-controls');
            
            const urlInput = document.createElement('input');
            urlInput.type = 'url';
            urlInput.className = 'image-input';
            urlInput.placeholder = 'Enter image URL (https://...)';
            urlInput.addEventListener('input', () => previewImageFromUrl(urlInput));
            
            optionsDiv.replaceWith(urlInput);
            urlInput.focus();
        }

        function showFileInput(button) {
            const section = button.closest('.card-input-section');
            const optionsDiv = button.closest('.image-controls');
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.className = 'image-file-input';
            fileInput.accept = 'image/*';
            fileInput.addEventListener('change', () => previewImageFromFile(fileInput));
            
            optionsDiv.replaceWith(fileInput);
            fileInput.click();
        }

        function cancelImageAdd(button) {
            const section = button.closest('.card-input-section');
            const optionsDiv = button.closest('.image-controls');
            const addButton = section.querySelector('.image-btn');
            
            optionsDiv.remove();
            addButton.textContent = '📷 Add Image';
            addButton.classList.remove('active');
        }

        function previewImageFromUrl(input) {
            const section = input.closest('.card-input-section');
            removeExistingImageElements(section);
            
            if (input.value.trim()) {
                const img = createImagePreview(input.value.trim());
                const removeBtn = createRemoveImageButton();
                
                section.appendChild(img);
                section.appendChild(removeBtn);
                updateImageButton(section, true);
            }
        }

        function previewImageFromFile(input) {
            const section = input.closest('.card-input-section');
            const file = input.files[0];
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    removeExistingImageElements(section);
                    
                    const img = createImagePreview(e.target.result);
                    const removeBtn = createRemoveImageButton();
                    
                    section.appendChild(img);
                    section.appendChild(removeBtn);
                    updateImageButton(section, true);
                };
                reader.readAsDataURL(file);
            }
        }

        function createImagePreview(src) {
            const img = document.createElement('img');
            img.className = 'image-preview';
            img.src = src;
            img.onerror = function() {
                this.style.border = '2px solid #e53e3e';
                this.alt = 'Failed to load image';
            };
            return img;
        }

        function createRemoveImageButton() {
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-image';
            removeBtn.textContent = 'Remove Image';
            removeBtn.onclick = function() { removeImage(this); };
            return removeBtn;
        }

        function removeExistingImageElements(section) {
            const existing = section.querySelectorAll('.image-preview, .remove-image');
            existing.forEach(el => el.remove());
        }

        function updateImageButton(section, hasImage) {
            const addButton = section.querySelector('.image-btn');
            addButton.textContent = hasImage ? '📷 Image Added' : '📷 Add Image';
            addButton.classList.toggle('active', hasImage);
        }

        function removeImage(button) {
            const section = button.closest('.card-input-section');
            const preview = section.querySelector('.image-preview');
            const input = section.querySelector('.image-input, .image-file-input');
            
            if (preview) preview.remove();
            if (input) input.remove();
            button.remove();
            
            updateImageButton(section, false);
        }

        // ===== SET OPERATIONS =====
        function saveSet() {
            const validation = validateSetForm();
            if (!validation.isValid) {
                showErrorMessage(validation.message);
                return;
            }

            const setData = collectSetData();
            
            if (editingIndex !== null) {
                updateExistingSet(setData);
            } else {
                createNewSet(setData);
            }
        }

        function validateSetForm() {
            const title = document.getElementById('setTitle').value.trim();
            if (!title) {
                return { isValid: false, message: 'Please enter a title for your set' };
            }

            const cards = collectCards();
            if (cards.validCards.length === 0) {
                return { isValid: false, message: 'Please add at least one complete card' };
            }

            if (cards.hasEmptyCard) {
                const proceed = confirm('Some cards are incomplete and will be skipped. Continue saving?');
                if (!proceed) {
                    return { isValid: false, message: 'Save cancelled' };
                }
            }

            return { isValid: true, cards: cards.validCards };
        }

        function collectSetData() {
            return {
                title: document.getElementById('setTitle').value.trim(),
                description: document.getElementById('setDescription').value.trim(),
                cards: validateSetForm().cards,
                created: editingIndex !== null ? savedSets[editingIndex].created : new Date().toLocaleDateString()
            };
        }

        function collectCards() {
            const cardItems = document.querySelectorAll('.card-item');
            const validCards = [];
            let hasEmptyCard = false;
            
            cardItems.forEach(item => {
                const card = extractCardData(item);
                if (card.isValid) {
                    validCards.push(card.data);
                } else if (card.hasContent) {
                    hasEmptyCard = true;
                }
            });
            
            return { validCards, hasEmptyCard };
        }

        function extractCardData(item) {
            const sections = item.querySelectorAll('.card-input-section');
            
            if (sections.length === 2) {
                const frontSection = sections[0];
                const backSection = sections[1];
                
                const front = frontSection.querySelector('.card-input').value.trim();
                const back = backSection.querySelector('.card-input').value.trim();
                
                const frontImg = frontSection.querySelector('.image-preview');
                const backImg = backSection.querySelector('.image-preview');
                
                const hasContent = front || back || frontImg || backImg;
                const isValid = hasContent && (front || frontImg) && (back || backImg);
                
                if (hasContent) {
                    const card = { front, back };
                    if (frontImg) card.frontImage = frontImg.src;
                    if (backImg) card.backImage = backImg.src;
                    return { isValid, hasContent, data: card };
                }
            }
            
            return { isValid: false, hasContent: false, data: null };
        }

        function createNewSet(setData) {
            savedSets.push(setData);
            saveSetsToStorage();
            showSuccessMessage(`Set "${setData.title}" saved with ${setData.cards.length} cards!`);
            showWelcomeScreen();
        }

        function updateExistingSet(setData) {
            savedSets[editingIndex] = setData;
            saveSetsToStorage();
            showSuccessMessage(`Set "${setData.title}" updated with ${setData.cards.length} cards!`);
            showWelcomeScreen();
        }

        // ===== EDIT FUNCTIONALITY =====
        function showEditScreen(index) {
            editingIndex = index;
            hideAllScreens();
            document.getElementById('createScreen').classList.remove('hidden');
            loadSetForEdit(index);
        }

        function loadSetForEdit(index) {
            const set = savedSets[index];
            
            // Populate form
            document.getElementById('setTitle').value = set.title;
            document.getElementById('setDescription').value = set.description || '';
            
            // Populate cards
            populateCardsForEdit(set.cards);
            
            // Update save button
            const saveButton = document.querySelector('#createScreen .btn-success');
            saveButton.textContent = 'Update Set';
        }

        function populateCardsForEdit(cards) {
            const cardsList = document.getElementById('cardsList');
            let html = '<div class="cards-separator">Existing Cards</div>';
            
            cards.forEach(card => {
                html += createCardItemHTML(card);
            });
            
            cardsList.innerHTML = html;
            updateRemoveButtons();
        }

        // ===== SET MANAGEMENT =====
        function confirmDeleteSet(index) {
            const setTitle = savedSets[index].title;
            if (confirm(`Are you sure you want to delete "${setTitle}"?\n\nThis action cannot be undone.`)) {
                savedSets.splice(index, 1);
                saveSetsToStorage();
                updateWelcomeScreen();
                showSuccessMessage(`"${setTitle}" has been deleted.`);
            }
        }

        function exportSet(index) {
            const set = savedSets[index];
            const dataStr = JSON.stringify(set, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${set.title.replace(/[^a-z0-9]/gi, '_')}_flashcards.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            setTimeout(() => {
                showSuccessMessage(`"${set.title}" exported successfully!\n\nFile saved as: ${link.download}`);
            }, 100);
        }

        // ===== FILE IMPORT =====
        function triggerImportFile() {
            document.getElementById('fileImport').click();
        }

        function triggerCreateImportFile() {
            document.getElementById('createFileImport').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const importedSet = parseImportedFile(file, content);
                    
                    savedSets.push(importedSet);
                    saveSetsToStorage();
                    updateWelcomeScreen();
                    showSuccessMessage(`Successfully imported "${importedSet.title}" with ${importedSet.cards.length} cards!`);
                } catch (error) {
                    showErrorMessage(`Error importing file: ${error.message}\n\nFor JSON files: Ensure the file contains a valid flashcard set.\nFor text files: Use format "term/definition" one per line.`);
                }
                
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function handleCreateFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    if (file.name.endsWith('.json')) {
                        loadJsonForEdit(content);
                    } else if (file.name.endsWith('.txt')) {
                        loadTextForEdit(file, content);
                    }
                } catch (error) {
                    showErrorMessage(`Error loading file: ${error.message}`);
                }
                
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function parseImportedFile(file, content) {
            if (file.name.endsWith('.json')) {
                const importedSet = JSON.parse(content);
                
                if (!importedSet.title || !Array.isArray(importedSet.cards)) {
                    throw new Error('Invalid file format. Expected JSON with title and cards array.');
                }
                
                const validCards = importedSet.cards.filter(card => 
                    card && typeof card.front === 'string' && typeof card.back === 'string'
                );
                
                if (validCards.length === 0) {
                    throw new Error('No valid cards found in file.');
                }
                
                return {
                    title: importedSet.title,
                    description: importedSet.description || '',
                    cards: validCards,
                    created: new Date().toLocaleDateString(),
                    imported: true
                };
            } else if (file.name.endsWith('.txt')) {
                const { cards } = parseBulkText(content);
                
                if (cards.length === 0) {
                    throw new Error('No valid cards found. Please use format: term/definition');
                }
                
                const fileName = file.name.replace(/\.[^/.]+$/, '');
                return {
                    title: fileName,
                    description: `Imported from ${file.name}`,
                    cards: cards,
                    created: new Date().toLocaleDateString(),
                    imported: true
                };
            }
            
            throw new Error('Unsupported file format. Please use JSON or TXT files.');
        }

        function loadJsonForEdit(content) {
            const importedSet = JSON.parse(content);
            
            if (!importedSet.title || !Array.isArray(importedSet.cards)) {
                throw new Error('Invalid JSON format');
            }
            
            document.getElementById('setTitle').value = importedSet.title;
            document.getElementById('setDescription').value = importedSet.description || '';
            populateCardsForEdit(importedSet.cards);
            
            showSuccessMessage(`Imported "${importedSet.title}" for editing!\nYou can now modify the cards and save as a new set.`);
        }

        function loadTextForEdit(file, content) {
            const textarea = document.getElementById('bulkTextarea');
            textarea.value = content;
            
            document.getElementById('bulkImportArea').classList.remove('hidden');
            document.getElementById('bulkImportToggle').textContent = '📝 Hide Bulk Import';
            
            if (!document.getElementById('setTitle').value) {
                const fileName = file.name.replace(/\.[^/.]+$/, '');
                document.getElementById('setTitle').value = fileName;
            }
            
            showSuccessMessage('Text file loaded into bulk import area.\nClick "Import Cards" to process the content.');
        }

        // ===== STUDY MODE =====
        function startStudying(setData) {
            currentSet = { ...setData, cards: [...setData.cards] }; // Deep copy to avoid mutations
            currentCardIndex = 0;
            isShowingFront = true;
            
            document.getElementById('studyTitle').textContent = setData.title;
            updateCard();
            updateProgress();
            updateNavigationButtons();
        }

        function updateCard() {
            if (!currentSet || currentSet.cards.length === 0) return;
            
            const card = currentSet.cards[currentCardIndex];
            const contentDiv = document.getElementById('cardContent');
            
            contentDiv.innerHTML = '';
            
            const content = isShowingFront ? 
                { text: card.front, image: card.frontImage } : 
                { text: card.back, image: card.backImage };
            
            if (content.image) {
                const img = document.createElement('img');
                img.className = 'card-image';
                img.src = content.image;
                img.alt = `${isShowingFront ? 'Front' : 'Back'} image`;
                contentDiv.appendChild(img);
            }
            
            if (content.text) {
                const textDiv = document.createElement('div');
                textDiv.className = 'card-text';
                textDiv.textContent = content.text;
                contentDiv.appendChild(textDiv);
            }
            
            if (!content.text && !content.image) {
                contentDiv.textContent = `(No ${isShowingFront ? 'front' : 'back'} content)`;
            }
            
            document.getElementById('flipIndicator').textContent = `Showing: ${isShowingFront ? 'Front' : 'Back'}`;
        }

        function updateProgress() {
            if (!currentSet) return;
            document.getElementById('progress').textContent = 
                `${currentCardIndex + 1} / ${currentSet.cards.length}`;
        }

        function updateNavigationButtons() {
            if (!currentSet) return;
            
            document.getElementById('prevBtn').disabled = currentCardIndex === 0;
            document.getElementById('nextBtn').disabled = currentCardIndex === currentSet.cards.length - 1;
        }

        function flipCard() {
            if (!currentSet) return;
            isShowingFront = !isShowingFront;
            updateCard();
        }

        function previousCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                isShowingFront = true;
                updateCard();
                updateProgress();
                updateNavigationButtons();
            }
        }

        function nextCard() {
            if (currentCardIndex < currentSet.cards.length - 1) {
                currentCardIndex++;
                isShowingFront = true;
                updateCard();
                updateProgress();
                updateNavigationButtons();
            }
        }

        function shuffleCards() {
            if (!currentSet || currentSet.cards.length <= 1) return;
            
            // Fisher-Yates shuffle algorithm
            const shuffled = [...currentSet.cards];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            currentSet.cards = shuffled;
            currentCardIndex = 0;
            isShowingFront = true;
            
            updateCard();
            updateProgress();
            updateNavigationButtons();
            
            // Visual feedback
            const shuffleBtn = document.getElementById('shuffleBtn');
            const originalText = shuffleBtn.textContent;
            const originalBg = shuffleBtn.style.background;
            
            shuffleBtn.textContent = '✨ Shuffled!';
            shuffleBtn.style.background = '#38a169';
            
            setTimeout(() => {
                shuffleBtn.textContent = originalText;
                shuffleBtn.style.background = originalBg;
            }, 1000);
        }

        // ===== UTILITY FUNCTIONS =====
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showErrorMessage(message) {
            alert(message);
        }

        function showSuccessMessage(message) {
            alert(message);
        }

        // ===== TEST APP INTEGRATION =====
        function openTestApp() {
            if (savedSets.length === 0) {
                alert('Create some flashcard sets first before testing yourself!\n\nClick "Create New Set" to get started.');
                return;
            }

            // Navigate to test app in the same tab
            window.location.href = 'flashtest.html';
        }

        function testSet(index) {
            if (index >= 0 && index < savedSets.length) {
                // Store the selected set for the test app
                localStorage.setItem('selectedTestSet', JSON.stringify(savedSets[index]));
                // Navigate to test app in the same tab
                window.location.href = 'flashtest.html';
            }
        }

        // ===== INITIALIZE APP =====
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>